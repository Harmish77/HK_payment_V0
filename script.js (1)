// Subscription tiers with amounts and days
const tiers = [
  { amount: 5, days: 3, label: "3-Day" },
  { amount: 10, days: 7, label: "Weekly" },
  { amount: 25, days: 30, label: "Monthly" },
  { amount: 60, days: 90, label: "3-Month", savings: "20%" },
  { amount: 100, days: 180, label: "6-Month", savings: "33%" },
  { amount: 150, days: 365, label: "Yearly", savings: "40%" }
];

// UPI payment details
const upiId = "harmish@superyes";
const name = "PremiumAccess";
let Amt = 0;
let qrTimeout;

// DOM Elements
const elements = {
  amountSelect: document.getElementById('amount'),
  customAmountDiv: document.getElementById('customAmountDiv'),
  customAmountInput: document.getElementById('customAmountInput'),
  periodDisplay: document.getElementById('period'),
  upiIdElement: document.getElementById('upiId'),
  qrCodeImage: document.getElementById('qrCode'),
  downloadBtn: document.getElementById('downloadBtn'),
  paymentDoneBtn: document.getElementById('paymentDoneBtn'),
  confirmationMsg: document.getElementById('confirmation-msg'),
  paymentForm: document.getElementById('payment-form'),
  usernameInput: document.getElementById('username'),
  txnIdInput: document.getElementById('txnId'),
  usernameError: document.getElementById('username-error'),
  txnIdError: document.getElementById('txnId-error'),
  submitBtn: document.getElementById('submitBtn'),
  toast: document.getElementById('toast'),
  toggleBtn: document.getElementById('toggleBtn')
};

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
  // Set up event listeners
  elements.amountSelect.addEventListener('change', onAmountChange);
  elements.customAmountInput.addEventListener('input', validateCustomAmount);
  elements.upiIdElement.addEventListener('click', copyUPIId);
  elements.downloadBtn.addEventListener('click', downloadQR);
  elements.paymentDoneBtn.addEventListener('click', showForm);
  elements.submitBtn.addEventListener('click', submitPayment);
  elements.toggleBtn.addEventListener('click', toggleMode);
  
  // Validate inputs in real-time
  elements.usernameInput.addEventListener('input', validateForm);
  elements.txnIdInput.addEventListener('input', validateForm);
  
  // Initialize QR code
  generateQR();
  
  // Make Telegram button draggable
  setupDraggableTelegramButton();
  
  // Initialize theme
  checkThemePreference();
});

// Improved time period formatting
function formatDaysToYMD(totalDays) {
  if (totalDays < 1) return "Less than 1 Day";
  
  const years = Math.floor(totalDays / 365);
  const months = Math.floor((totalDays % 365) / 30);
  const days = Math.floor((totalDays % 365) % 30);
  
  // Special cases for cleaner display
  if (years >= 1 && months === 0 && days === 0) {
    return years === 1 ? "1 Year" : `${years} Years`;
  }
  if (months >= 1 && days === 0) {
    return months === 1 ? "1 Month" : `${months} Months`;
  }
  if (days > 0 && months === 0 && years === 0) {
    return days === 1 ? "1 Day" : `${days} Days`;
  }
  
  // Build parts array only for mixed durations
  const parts = [];
  if (years > 0) parts.push(years === 1 ? "1 Year" : `${years} Years`);
  if (months > 0) parts.push(months === 1 ? "1 Month" : `${months} Months`);
  if (days > 0) parts.push(days === 1 ? "1 Day" : `${days} Days`);
  
  return parts.join(" ");
}


function interpolateCustomDays(amount) {
  // Clamp amount between minimum and maximum tier values
  amount = Math.max(5, Math.min(150, amount));
  
  // 1. Check for exact tier match
  const exactTier = tiers.find(t => t.amount === amount);
  if (exactTier) return exactTier.days;
  
  // 2. Handle amounts below first tier
  if (amount < tiers[0].amount) {
    return Math.max(1, Math.round((amount / tiers[0].amount) * tiers[0].days));
  }
  
  // 3. Handle amounts above last tier
  if (amount > tiers[tiers.length - 1].amount) {
    return Math.round((amount / tiers[tiers.length - 1].amount) * tiers[tiers.length - 1].days);
  }
  
  // 4. Find the tier bracket the amount falls into
  let lowerTier, upperTier;
  for (let i = 0; i < tiers.length - 1; i++) {
    if (amount >= tiers[i].amount && amount <= tiers[i+1].amount) {
      lowerTier = tiers[i];
      upperTier = tiers[i+1];
      break;
    }
  }
  
  // 5. Calculate proportional days based on tier rates
  const lowerRate = lowerTier.amount / lowerTier.days;
  const upperRate = upperTier.amount / upperTier.days;
  
  // Calculate days using weighted average of tier rates
  const weight = (amount - lowerTier.amount) / (upperTier.amount - lowerTier.amount);
  const effectiveRate = lowerRate + (upperRate - lowerRate) * weight;
  
  return Math.round(amount / effectiveRate);
}

// Updated period display function
function updatePeriod(amountValue) {
  if (!amountValue || amountValue === "") {
    elements.periodDisplay.innerText = "";
    return;
  }
  
  const amount = Number(amountValue);
  if (isNaN(amount)) {
    elements.periodDisplay.innerText = "Invalid amount";
    return;
  }
  
  if (amount < 5) {
    elements.periodDisplay.innerText = "Minimum amount is â‚¹5";
    return;
  }
  
  if (amount > 150) {
    elements.periodDisplay.innerText = "Maximum amount is â‚¹150";
    return;
  }
  
  // Calculate days based on amount
  const days = interpolateCustomDays(amount);
  
  // Find matching tier for savings info
  const tier = tiers.find(t => t.amount === amount);
  
  // Format display text
  let displayText = `Time Period: ${formatDaysToYMD(days)}`;
  
  // Calculate and show savings if available
  if (tier && tier.savings) {
    displayText += ` (Save ${tier.savings})`;
  } else if (days > 0) {
    // Calculate effective savings compared to base rate
    const baseRate = tiers[0].amount / tiers[0].days;
    const effectiveRate = amount / days;
    const savingsPercent = Math.round((1 - effectiveRate / baseRate) * 100);
    
    if (savingsPercent > 0) {
      displayText += ` (Save ~${savingsPercent}%)`;
    }
  }
  
  elements.periodDisplay.innerText = displayText;
}

// Handle amount selection change
function onAmountChange() {
  if (elements.amountSelect.value === "custom") {
    elements.customAmountDiv.style.display = "block";
    elements.customAmountInput.value = "";
    elements.customAmountInput.setAttribute("max", "150");
    elements.periodDisplay.innerText = "";
    elements.customAmountInput.focus();
  } else {
    elements.customAmountDiv.style.display = "none";
    updatePeriod(elements.amountSelect.value);
  }
  generateQR();
}

// Validate custom amount input
function validateCustomAmount() {
  const value = parseInt(elements.customAmountInput.value);
  
  if (isNaN(value)) {
    return;
  }
  
  if (value > 150) {
    elements.customAmountInput.value = 150;
    alert("Maximum custom amount is â‚¹150");
  } else if (value < 1) {
    alert("Minimum custom amount is â‚¹5");
    elements.customAmountInput.value = 5;
  }
  
  generateQR();
}

// Copy UPI ID to clipboard
function copyUPIId() {
  navigator.clipboard.writeText(upiId)
    .then(() => {
      elements.upiIdElement.classList.add("copied");
      setTimeout(() => elements.upiIdElement.classList.remove("copied"), 1500);
    });
}

// Generate QR code with debounce for custom amounts
function generateQR() {
  const select = elements.amountSelect;
  let value = select.value;
  
  if (value === "custom") {
    value = elements.customAmountInput.value || 5; // Default to 5 if empty
    clearTimeout(qrTimeout);
    qrTimeout = setTimeout(() => {
      // Validate amount is at least 5
      if (value < 5) {
        showToast("Minimum amount is â‚¹5", "error");
        elements.customAmountInput.value = 5;
        value = 5;
      }
      updatePeriod(value);
      createQRCode(value);
    }, 800);
  } else {
    updatePeriod(value);
    createQRCode(value);
  }
}

// Create the actual QR code
function createQRCode(amount) {
  amount = Math.max(5, amount); // Ensure amount is never less than 5
  Amt = amount;
  const tier = tiers.find(t => t.amount === Number(amount));
  const periodText = tier ? tier.label : formatDaysToYMD(interpolateCustomDays(amount));
  
  const tn = `MovieHub Premium (${periodText}) - Thank you!`;
  const upiURL = `upi://pay?pa=${upiId}&pn=${name}&am=${amount}&cu=INR&tn=${encodeURIComponent(tn)}`;
  
  const size = 500;
  const logoSize = 100;
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  
  const qr = new QRious({
    element: canvas,
    value: upiURL,
    size: size,
    level: 'H'
  });
  
  const ctx = canvas.getContext("2d");
  
  const logo = new Image();
  logo.crossOrigin = "anonymous";
  logo.src = "movie hub logo.jpg";
  
  logo.onload = function() {
    const centerX = (canvas.width - logoSize) / 2;
    const centerY = (canvas.height - logoSize) / 2;
    
    // Draw circular clip and logo
    ctx.save();
    ctx.beginPath();
    ctx.arc(centerX + logoSize/2, centerY + logoSize/2, logoSize/2, 0, Math.PI*2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(logo, centerX, centerY, logoSize, logoSize);
    ctx.restore();
    
    // Draw white border around logo
    ctx.beginPath();
    ctx.arc(centerX + logoSize/2, centerY + logoSize/2, logoSize/2 + 4, 0, Math.PI*2);
    ctx.strokeStyle = "#ffffff";
    ctx.lineWidth = 8;
    ctx.stroke();
    
    // Draw amount text with styling
    const text = `â‚¹${amount}`;
    const textX = canvas.width / 2;
    const textY = centerY + logoSize + 25;

    ctx.font = "bold 60px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "top";

    // White border around text
    ctx.lineWidth = 26;
    ctx.strokeStyle = "white";
    ctx.strokeText(text, textX, textY);

    // Solid black fill
    ctx.fillStyle = "#000";
    ctx.fillText(text, textX, textY);
    
    // Set the QR image source from canvas
    elements.qrCodeImage.src = canvas.toDataURL("image/png", 1.0);
  };
}

// Download QR code as PNG
function downloadQR() {
  const img = elements.qrCodeImage;
  if (!img.src) {
    alert("Please generate the QR code first.");
    return;
  }
  
  const link = document.createElement('a');
  link.href = img.src;
  link.download = `MovieHub-Payment-â‚¹${Amt}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Show toast notification
  showToast("QR code downloaded!");
}

// Show payment form
function showForm() {
  elements.paymentForm.style.opacity = "5";
  elements.paymentForm.style.maxHeight = "500px";
  elements.paymentForm.style.padding = "20px";
  elements.paymentForm.style.margin = "30px auto";
  elements.paymentDoneBtn.style.display = "none";
}

// Validate form inputs
function validateForm() {
  const username = elements.usernameInput.value.trim();
  const txnId = elements.txnIdInput.value.trim();
  
  // Validate username
  if (username.length < 3 || username.length > 32) {
    elements.usernameError.textContent = "Username must be 3-32 characters";
    elements.usernameError.style.display = "block";
    elements.usernameInput.classList.add("error");
  } else {
    elements.usernameError.style.display = "none";
    elements.usernameInput.classList.remove("error");
  }
  
  // Validate transaction ID
  if (!/^\d{12}$/.test(txnId)) {
    elements.txnIdError.textContent = "Transaction ID must be 12 digits";
    elements.txnIdError.style.display = "block";
    elements.txnIdInput.classList.add("error");
  } else {
    elements.txnIdError.style.display = "none";
    elements.txnIdInput.classList.remove("error");
  }
  
  // Enable submit button if all valid
  elements.submitBtn.disabled = !(
    username.length >= 3 && 
    username.length <= 32 && 
    /^\d{12}$/.test(txnId)
  );
}

// Sanitize input to prevent XSS
function sanitizeInput(input) {
  return input.replace(/[<>'"&]/g, '');
}

// Submit payment details
async function submitPayment() {
  const username = elements.usernameInput.value.trim();
  const txnId = elements.txnIdInput.value.trim();
  const select = elements.amountSelect;
  const customInput = elements.customAmountInput;
  
  // Disable button during submission
  elements.submitBtn.disabled = true;
  elements.submitBtn.textContent = "Processing...";
  
  try {
    const amount = select.value === "custom" ? Number(customInput.value.trim()) : Number(select.value);
    
    // Validate inputs
    if (!validateUsername(username) || !/^\d{12}$/.test(txnId) || isNaN(amount) || amount <= 0) {
      if (!validateUsername(username)) {
        elements.usernameInput.style.border = "2px solid red";
        elements.usernameError.style.display = "block";
      }
      if (!/^\d{12}$/.test(txnId)) {
        elements.txnIdInput.style.border = "2px solid red";
        elements.txnIdError.style.display = "block";
      }
      if (isNaN(amount) || amount <= 0 || amount > 150) {
        alert("Please enter a valid amount between â‚¹5 and â‚¹150.");
        return;
      }
      alert("Please fill in all fields correctly.");
      return;
    }
    
    // Add small delay for better UX
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Calculate time period
    const days = interpolateCustomDays(amount);
    const period = formatDaysToYMD(days);
    
    // Sanitize inputs
    const safeUsername = sanitizeInput(username);
    const safeTxnId = sanitizeInput(txnId);
    
    // Show confirmation message
    elements.confirmationMsg.textContent = `Thank you, @${safeUsername}. Redirecting to Telegram...`;
    elements.confirmationMsg.style.display = "block";
    
    // Auto-hide form
    elements.paymentForm.style.opacity = "0";
    elements.paymentForm.style.maxHeight = "0";
    
    // Build Telegram message
    const message = `ðŸ‘‹ Hi there!%0A%0Aâœ… I have successfully completed the payment.%0A%0AðŸ“± Telegram Username: %60@${encodeURIComponent(safeUsername)}%60%0AðŸ’³ Transaction ID: %60${encodeURIComponent(safeTxnId)}%60%0AðŸ’° Amount Paid: %60â‚¹${amount}%60%0Aâ³ Time Period: %60${period}%60%0A%0AðŸ“¸ I will send the payment screenshot shortly.%0A%0AðŸ™ Thank you!`;
    
    const tgLink = `https://t.me/Mr_HKs?text=${message}`;
    
    // Open Telegram after short delay
    setTimeout(() => {
      window.open(tgLink, "_blank");
    }, 2000);
  } catch (error) {
    console.error("Submission error:", error);
    alert("An error occurred. Please try again.");
  } finally {
    elements.submitBtn.disabled = false;
    elements.submitBtn.textContent = "Submit & Send Screenshot";
  }
}

// Validate Telegram username format
function validateUsername(username) {
  return /^[a-z0-9_]{3,32}$/i.test(username) && !username.startsWith('@');
}

// Show toast notification
function showToast(message = "QR code downloaded!", type = "success") {
  const toast = elements.toast;
  toast.textContent = message;
  toast.style.backgroundColor = type === "error" ? "#ef4444" : "#22c55e";
  
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
}

// Toggle dark/light mode
function toggleMode() {
  document.body.classList.toggle('light-mode');
  const isLight = document.body.classList.contains('light-mode');
  elements.toggleBtn.textContent = isLight ? 'ðŸŒ™' : 'â˜€ï¸';
  elements.toggleBtn.classList.toggle('dark', !isLight);
  elements.toggleBtn.classList.toggle('light', isLight);
  
  // Save preference
  localStorage.setItem('themePreference', isLight ? 'light' : 'dark');
}

// Check for saved theme preference
function checkThemePreference() {
  const savedTheme = localStorage.getItem('themePreference');
  if (savedTheme === 'light') {
    document.body.classList.add('light-mode');
    elements.toggleBtn.textContent = 'ðŸŒ™';
    elements.toggleBtn.classList.add('light');
    elements.toggleBtn.classList.remove('dark');
  }
}

// Setup draggable Telegram button
function setupDraggableTelegramButton() {
  const btn = document.getElementById("telegram-btn");
  let isDragging = false;
  let offsetX, offsetY;

  function startDrag(x, y) {
    isDragging = true;
    offsetX = x - btn.getBoundingClientRect().left;
    offsetY = y - btn.getBoundingClientRect().top;
    btn.style.cursor = 'grabbing';
  }

  function doDrag(x, y) {
    if (!isDragging) return;
    btn.style.left = (x - offsetX) + 'px';
    btn.style.top = (y - offsetY) + 'px';
    btn.style.right = 'auto';
    btn.style.bottom = 'auto';
  }

  function endDrag() {
    isDragging = false;
    btn.style.cursor = 'grab';
  }

  // Mouse events
  btn.addEventListener('mousedown', (e) => {
    e.preventDefault();
    startDrag(e.clientX, e.clientY);
  });
  document.addEventListener('mousemove', (e) => {
    doDrag(e.clientX, e.clientY);
  });
  document.addEventListener('mouseup', endDrag);

  // Touch events
  btn.addEventListener('touchstart', (e) => {
    const touch = e.touches[0];
    startDrag(touch.clientX, touch.clientY);
  });
  document.addEventListener('touchmove', (e) => {
    const touch = e.touches[0];
    doDrag(touch.clientX, touch.clientY);
  });
  document.addEventListener('touchend', endDrag);
}